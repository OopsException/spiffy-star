---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

// Generate static paths for each tag used in the `blog` collection
export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const slugify = (s: string) =>
    String(s)
      .toLowerCase()
      .trim()
      .replace(/\s+/g, '-')
      .replace(/[^a-z0-9-_]/g, '')
      .replace(/--+/g, '-');

  const tags = new Set<string>();
  posts.forEach((p) => {
    (p.data.tags || []).forEach((t) => tags.add(slugify(t)));
  });

  return Array.from(tags).map((tag) => ({ params: { category: tag } }));
}

const { category } = Astro.params;

// fallback for typescript
const categorySafe = category ?? '';

const allPosts = await getCollection('blog');

// Filter posts by matching tags
const posts = allPosts.filter((p) =>
  (p.data.tags || []).map((t) => t.toLowerCase()).includes(categorySafe.toLowerCase())
);

// Convert "brew-guides" â†’ "Brew Guides"
const categoryLabel = categorySafe
  .replace(/-/g, ' ')
  .replace(/\b\w/g, (c) => c.toUpperCase());
---

<html lang="en">
  <head>
    <BaseHead title={categoryLabel} description={`Posts under ${categoryLabel}`} />
  </head>

  <body>
    <Header />

    <main style="max-width:900px;margin:2rem auto;padding:0 1rem;">
      <h1 style="text-align:center;font-size:2rem;margin-bottom:2rem;">
        {categoryLabel}
      </h1>

      {posts.length === 0 ? (
        <p>No posts yet in this category.</p>
      ) : (
        posts.map((post) => (
          <div style="margin-bottom:2rem;">
            <a href={`/blog/${post.id}`} style="font-size:1.2rem;color:var(--text);text-decoration:none;">
              {post.data.title}
            </a>
            <p style="color:var(--text-muted);">{post.data.description}</p>
          </div>
        ))
      )}
    </main>

    <Footer />
  </body>
</html>
